<!DOCTYPE html>
<html>
   

<head>
           
    <meta charset="utf-8">
            <title>cannon.js + three.js physics shooter</title>
            <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            background-color: #ffffff;
            margin: 0;
            overflow: hidden;
            font-family: arial;
        }
        #power { 
                position: fixed;
                top: 0;
                center:0;
                color:white;
                padding:5px;
                text-align:center;
                font-size:30pt;
        }

        #blocker {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #instructions,
        #success {
            width: 100%;
            height: 100%;
            display: -webkit-box;
            display: -moz-box;
            display: box;
            -webkit-box-orient: horizontal;
            -moz-box-orient: horizontal;
            box-orient: horizontal;
            -webkit-box-pack: center;
            -moz-box-pack: center;
            box-pack: center;
            -webkit-box-align: center;
            -moz-box-align: center;
            box-align: center;
            color: #ffffff;
            text-align: center;
            cursor: pointer;
        }
    </style>
       
</head>
   

<body>
           
    <script src="../libs/Three.js"></script>
           
    <script src="../build/cannon.js"></script>
           
    <script src="js/PointerLockControls.js"></script>
           
    <script src="js/Stage1.js"></script>
           
    <script src="js/Stage2.js"></script>
           
    <script>var num_try;</script>
            <div id="blocker">
                    <div id="instructions">
                            <span style="font-size:40px">stage1</span>
                            <br />
                            If you fall green block, stage cleared!
                            <br/>
                            <button id = "next" onClick="location.href='threejs_fps2.html'"> Next Stage</button>
                            <button id = "home" onClick="location.href='BoomBoom.html'"> Home</button>
                            <button id = "again" onClick='self.close()'> Try Again </button>
                        </div>
                    <div id="success">
                            <span style="font-size:40px">Stage1 Clear!</span>
                            
                        </div>
                </div>
            <div id='power'>0</div>      
    <script>
        var sphereShape, sphereBody, world, physicsMaterial, walls = [], balls = [], ballMeshes = [], boxes = [], boxMeshes = [];
        var stage_clear = false;
        var reset_state = false;
        var camera, scene, renderer;
        var geometry, material, mesh;
        var controls, time = Date.now();
        var blocker = document.getElementById('blocker');
        var instructions = document.getElementById('instructions');
        var success = document.getElementById('success');
        // var next = document.getElementById("next");
        var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

        if (havePointerLock) {
            var element = document.body;
            var pointerlockchange = function (event) {
                if (document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element) {
                    controls.enabled = true;
                    blocker.style.display = 'none';
                } else {
                    controls.enabled = false;
                    blocker.style.display = '-webkit-box';
                    blocker.style.display = '-moz-box';
                    blocker.style.display = 'box';
                    instructions.style.display = '';
                }
            }
            var pointerlockerror = function (event) {
                instructions.style.display = '';
            }
            // Hook pointer lock state change events
            
            document.addEventListener('pointerlockchange', pointerlockchange, false);
            document.addEventListener('mozpointerlockchange', pointerlockchange, false);
            document.addEventListener('webkitpointerlockchange', pointerlockchange, false);
            document.addEventListener('pointerlockerror', pointerlockerror, false);
            document.addEventListener('mozpointerlockerror', pointerlockerror, false);
            document.addEventListener('webkitpointerlockerror', pointerlockerror, false);
            instructions.addEventListener('click', function (event) {
                instructions.style.display = 'none';
                // Ask the browser to lock the pointer
                element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;
                if (/Firefox/i.test(navigator.userAgent)) {
                    var fullscreenchange = function (event) {
                        if (document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element) {
                            document.removeEventListener('fullscreenchange', fullscreenchange);
                            document.removeEventListener('mozfullscreenchange', fullscreenchange);
                            element.requestPointerLock();
                        }
                    }
                    document.addEventListener('fullscreenchange', fullscreenchange, false);
                    document.addEventListener('mozfullscreenchange', fullscreenchange, false);
                    element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;
                    element.requestFullscreen();
                } else {
                    element.requestPointerLock();
                }
            }, false);
        } else {
            instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';
        }

        var stageStage = 1;
        switch (stageStage) {
            case 1:
                stage1();
                break;
            case 2:
                stage2();
                break;
        }
        //Erased innitCannon(), init(), anmaite() code
        var ballShape = new CANNON.Sphere(0.2);
        var ballGeometry = new THREE.SphereGeometry(ballShape.radius, 32, 32);
        var shootDirection = new THREE.Vector3();
        var shootVelo = 5;
        var projector = new THREE.Projector();
        function getShootDir(targetVec) {
            var vector = targetVec;
            targetVec.set(0, 0, 1);
            projector.unprojectVector(vector, camera);
            var ray = new THREE.Ray(sphereBody.position, vector.sub(sphereBody.position).normalize());
            targetVec.copy(ray.direction);
        }
        num_try = 0;
		
		window.addEventListener("mousedown", function(e){
			
				timer = setInterval(function() {
				shootVelo+=2;
				}, 100);
				
			});
			
       window.addEventListener("mouseup",function(e){
				clearInterval(timer);
				console.log(shootVelo);
                power.innerHTML = shootVelo;
                num_try =num_try+1;
                console.log(num_try)
                if(controls.enabled==true && num_try<5){
                    var x = sphereBody.position.x;
                    var y = sphereBody.position.y;
                    var z = sphereBody.position.z;
                    var ballBody = new CANNON.Body({ mass: 1 });
                    ballBody.addShape(ballShape);
                    var ballMesh = new THREE.Mesh( ballGeometry, material );
                    world.addBody(ballBody);
                    scene.add(ballMesh);
                    ballMesh.castShadow = true;
                    ballMesh.receiveShadow = true;
                    balls.push(ballBody);
                    ballMeshes.push(ballMesh);
                    getShootDir(shootDirection);
                    ballBody.velocity.set(  shootDirection.x * shootVelo,
                                            shootDirection.y * shootVelo,
                                            shootDirection.z * shootVelo);

                    // Move the ball outside the player sphere
                    x += shootDirection.x * (sphereShape.radius*1.02 + ballShape.radius);
                    y += shootDirection.y * (sphereShape.radius*1.02 + ballShape.radius);
                    z += shootDirection.z * (sphereShape.radius*1.02 + ballShape.radius);
                    ballBody.position.set(x,y,z);
                    ballMesh.position.set(x,y,z);
					shootVelo=5;
                }
				else{
					console.log("out of ball");
				}
            });
	  
        function clear() {

            if (stage_clear === true && reset_state === false) {
                console.log(stage_clear);
                controls.enabled = false;
                blocker.style.display = '-webkit-box';
                blocker.style.display = '-moz-box';
                blocker.style.display = 'box';
                instructions.style.display = '';
            }
            //clear 화면 없애기
            if (stage_clear === true) {
                window.addEventListener("click", function () {
                    controls.enabled = true;
                    console.log('clicked');
                    reset_state = true;
                    console.log(reset_state);
                    blocker.style.display = 'none';
                    //success.style.display = 'none';
                    stage_clear = false;
                    console.log(stage_clear);
                    // reset_state = false;
                    // console.log(reset_state);
                    //scene.remove(boxMeshes[0]);
                    //scene.remove(boxMeshes[1]);
                    console.log(boxes.length + 'before');
                    boxes.splice(0, boxes.length)
                    boxMeshes.splice(0, boxMeshes.length)
                    console.log(boxes.length + 'after');
                    //stageStage++;
                });
            }

        }
    </script>
       
</body>

</html>